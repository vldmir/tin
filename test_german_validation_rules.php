<?php

require_once 'vendor/autoload.php';

use vldmir\Tin\TIN;
use vldmir\Tin\TINException;

echo "üîç –ü–†–û–í–ï–†–ö–ê –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø –í–ê–õ–ò–î–ê–¶–ò–ò –ù–ï–ú–ï–¶–ö–ò–• TIN –ü–†–ê–í–ò–õ–ê–ú\n";
echo str_repeat("=", 60) . "\n\n";

// –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –Ω–µ–º–µ—Ü–∫–∏—Ö TIN
echo "üìã –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–ê–í–ò–õ–ê –ù–ï–ú–ï–¶–ö–ò–• TIN:\n";
echo "1. IdNr (Identifikationsnummer):\n";
echo "   - –î–ª–∏–Ω–∞: 11 —Ü–∏—Ñ—Ä\n";
echo "   - –ü–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞: –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å 0\n";
echo "   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–µ—Ä–≤—ã—Ö 10 —Ü–∏—Ñ—Ä:\n";
echo "     ‚Ä¢ –¢–æ—á–Ω–æ –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã\n";
echo "     ‚Ä¢ –¢–æ—á–Ω–æ –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (0-9)\n";
echo "     ‚Ä¢ –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –ø–æ –æ–¥–Ω–æ–º—É —Ä–∞–∑—É\n";
echo "   - 11-—è —Ü–∏—Ñ—Ä–∞: –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞\n\n";

echo "2. StNr (Steuernummer):\n";
echo "   - –î–ª–∏–Ω–∞: 11 —Ü–∏—Ñ—Ä\n";
echo "   - –ü–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞: –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å 0\n";
echo "   - –ù–µ—Ç —Ç—Ä–µ—Ö –ø–æ–¥—Ä—è–¥ –∏–¥—É—â–∏—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ü–∏—Ñ—Ä\n";
echo "   - –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä—ã\n";
echo "   - –ú–∏–Ω–∏–º—É–º –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è 2 –∏–ª–∏ 3 —Ä–∞–∑–∞\n";
echo "   - 11-—è —Ü–∏—Ñ—Ä–∞: –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞\n\n";

// –¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤–∏–ª
$testCases = [
    // –í–∞–ª–∏–¥–Ω—ã–µ IdNr (—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º)
    '26954371827' => ['type' => 'IdNr', 'description' => '–í–∞–ª–∏–¥–Ω—ã–π IdNr - –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã, –æ–¥–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'],
    '86095742719' => ['type' => 'IdNr', 'description' => '–í–∞–ª–∏–¥–Ω—ã–π IdNr - –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã, –æ–¥–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'],
    
    // –í–∞–ª–∏–¥–Ω—ã–µ StNr (—Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º)
    '65929970489' => ['type' => 'StNr', 'description' => '–í–∞–ª–∏–¥–Ω—ã–π StNr - –Ω–µ—Ç —Ç—Ä–µ—Ö –ø–æ–¥—Ä—è–¥ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö, –µ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'],
    
    // –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ —Å–ª—É—á–∞–∏
    '12345678901' => ['type' => 'invalid', 'description' => '–í—Å–µ —Ü–∏—Ñ—Ä—ã —Ä–∞–∑–Ω—ã–µ - –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º IdNr'],
    '11111111111' => ['type' => 'invalid', 'description' => '–í—Å–µ —Ü–∏—Ñ—Ä—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ - –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ'],
    '12345678900' => ['type' => 'invalid', 'description' => '–¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã –ø–æ–¥—Ä—è–¥ (000) - –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è StNr'],
    '02345678901' => ['type' => 'invalid', 'description' => '–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0 - –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ'],
    '26954371828' => ['type' => 'invalid', 'description' => '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞'],
];

echo "üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–ê–í–ò–õ:\n";
echo str_repeat("-", 60) . "\n";

foreach ($testCases as $number => $expected) {
    echo "–¢–µ—Å—Ç: $number\n";
    echo "–û–∂–∏–¥–∞–µ–º—ã–π —Ç–∏–ø: {$expected['type']}\n";
    echo "–û–ø–∏—Å–∞–Ω–∏–µ: {$expected['description']}\n";
    
    try {
        $tin = TIN::from('DE', $number);
        $isValid = $tin->isValid();
        $type = $tin->identifyTinType();
        
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏: " . ($isValid ? '‚úÖ –í–ê–õ–ò–î–ï–ù' : '‚ùå –ù–ï–í–ê–õ–ò–î–ï–ù') . "\n";
        
        if ($isValid && $type) {
            echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø: {$type['code']} - {$type['name']}\n";
        }
        
        // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è IdNr
        if ($expected['type'] === 'IdNr' || $expected['type'] === 'invalid') {
            $digits = str_split(substr($number, 0, 10)); // –ü–µ—Ä–≤—ã–µ 10 —Ü–∏—Ñ—Ä
            $digitCount = array_count_values($digits);
            
            $missing = [];
            $twice = [];
            $once = [];
            
            for ($i = 0; $i <= 9; $i++) {
                $count = $digitCount[$i] ?? 0;
                if ($count === 0) {
                    $missing[] = $i;
                } elseif ($count === 2) {
                    $twice[] = $i;
                } elseif ($count === 1) {
                    $once[] = $i;
                }
            }
            
            echo "–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã IdNr:\n";
            echo "  - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ü–∏—Ñ—Ä—ã: " . implode(', ', $missing) . " (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: " . count($missing) . ")\n";
            echo "  - –¶–∏—Ñ—Ä—ã –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è –¥–≤–∞–∂–¥—ã: " . implode(', ', $twice) . " (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: " . count($twice) . ")\n";
            echo "  - –¶–∏—Ñ—Ä—ã –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è –æ–¥–∏–Ω —Ä–∞–∑: " . implode(', ', $once) . " (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: " . count($once) . ")\n";
            
            $followsIdNrRules = count($missing) === 1 && count($twice) === 1 && count($once) === 8;
            echo "  - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º IdNr: " . ($followsIdNrRules ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢') . "\n";
        }
        
        // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è StNr
        if ($expected['type'] === 'StNr' || $expected['type'] === 'invalid') {
            $digits = str_split($number);
            $hasThreeConsecutive = false;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç—Ä–∏ –ø–æ–¥—Ä—è–¥ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã
            for ($i = 0; $i < 9; $i++) {
                if ($digits[$i] === $digits[$i + 1] && $digits[$i] === $digits[$i + 2]) {
                    $hasThreeConsecutive = true;
                    break;
                }
            }
            
            $digitCount = array_count_values($digits);
            $hasRepetition = false;
            $maxRepetition = 0;
            
            foreach ($digitCount as $count) {
                if ($count >= 2) {
                    $hasRepetition = true;
                }
                if ($count > $maxRepetition) {
                    $maxRepetition = $count;
                }
            }
            
            echo "–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã StNr:\n";
            echo "  - –¢—Ä–∏ –ø–æ–¥—Ä—è–¥ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã: " . ($hasThreeConsecutive ? '‚ùå –ï–°–¢–¨' : '‚úÖ –ù–ï–¢') . "\n";
            echo "  - –ï—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Ü–∏—Ñ—Ä: " . ($hasRepetition ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢') . "\n";
            echo "  - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ: $maxRepetition\n";
            
            $followsStNrRules = !$hasThreeConsecutive && $hasRepetition && $maxRepetition <= 3;
            echo "  - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º StNr: " . ($followsStNrRules ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢') . "\n";
        }
        
    } catch (TINException $e) {
        echo "‚ùå –û–®–ò–ë–ö–ê: " . $e->getMessage() . "\n";
    }
    
    echo "\n" . str_repeat("-", 60) . "\n\n";
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤
echo "üî¨ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–ï–°–¢–´ –ì–†–ê–ù–ò–ß–ù–´–• –°–õ–£–ß–ê–ï–í:\n";
echo str_repeat("-", 60) . "\n";

$edgeCases = [
    '12345678901' => '–í—Å–µ —Ü–∏—Ñ—Ä—ã —Ä–∞–∑–Ω—ã–µ (–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç IdNr)',
    '11223344556' => '–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç IdNr)',
    '12345678900' => '–¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–¥—Ä—è–¥ (–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç StNr)',
    '11123456789' => '–¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–¥—Ä—è–¥ (–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç StNr)',
    '12345678911' => '–¢—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–¥—Ä—è–¥ (–Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç StNr)',
];

foreach ($edgeCases as $number => $description) {
    echo "–¢–µ—Å—Ç: $number - $description\n";
    
    try {
        $tin = TIN::from('DE', $number);
        $isValid = $tin->isValid();
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: " . ($isValid ? '‚úÖ –í–ê–õ–ò–î–ï–ù' : '‚ùå –ù–ï–í–ê–õ–ò–î–ï–ù') . "\n";
        
        if ($isValid) {
            $type = $tin->identifyTinType();
            echo "–¢–∏–ø: {$type['code']}\n";
        }
    } catch (TINException $e) {
        echo "‚ùå –û–®–ò–ë–ö–ê: " . $e->getMessage() . "\n";
    }
    
    echo "\n";
}

echo "üìä –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï:\n";
echo "–ù–∞—à–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ–º–µ—Ü–∫–∏—Ö TIN —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∞–≤–∏–ª–∞–º:\n";
echo "‚úÖ –î–ª–∏–Ω–∞ 11 —Ü–∏—Ñ—Ä\n";
echo "‚úÖ –ü–µ—Ä–≤–∞—è —Ü–∏—Ñ—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å 0\n";
echo "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è IdNr\n";
echo "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è StNr\n";
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ü–∏—Ñ—Ä –¥–ª—è IdNr (–æ–¥–Ω–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã, –æ–¥–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n";
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ü–∏—Ñ—Ä –¥–ª—è StNr (–Ω–µ—Ç —Ç—Ä–µ—Ö –ø–æ–¥—Ä—è–¥ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö)\n";
echo "‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n";
echo "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ TIN\n\n";

echo "üéØ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–≥–ª–∞—Å–Ω–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º –Ω–µ–º–µ—Ü–∫–∏—Ö TIN!\n"; 