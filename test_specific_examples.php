<?php

require_once 'vendor/autoload.php';

use vldmir\Tin\TIN;
use vldmir\Tin\TINException;

echo "üîç –ü–†–û–í–ï–†–ö–ê –ö–û–ù–ö–†–ï–¢–ù–´–• –ü–†–ò–ú–ï–†–û–í –ù–ï–ú–ï–¶–ö–ò–• TIN\n";
echo str_repeat("=", 60) . "\n\n";

// –ü—Ä–∏–º–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ —Ä–∞–Ω–µ–µ
$examples = [
    '12 345 678 901' => '–ü—Ä–∏–º–µ—Ä —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π IdNr)',
    '48 036 952 129' => '–ü—Ä–∏–º–µ—Ä —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π IdNr)',
    '26954371827' => '–ò–∑–≤–µ—Å—Ç–Ω—ã–π –≤–∞–ª–∏–¥–Ω—ã–π IdNr',
    '86095742719' => '–ò–∑–≤–µ—Å—Ç–Ω—ã–π –≤–∞–ª–∏–¥–Ω—ã–π IdNr',
    '65929970489' => '–ò–∑–≤–µ—Å—Ç–Ω—ã–π –≤–∞–ª–∏–¥–Ω—ã–π StNr',
];

foreach ($examples as $number => $description) {
    echo "–¢–µ—Å—Ç: $number\n";
    echo "–û–ø–∏—Å–∞–Ω–∏–µ: $description\n";
    
    try {
        $tin = TIN::from('DE', $number);
        $isValid = $tin->isValid();
        $type = $tin->identifyTinType();
        
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏: " . ($isValid ? '‚úÖ –í–ê–õ–ò–î–ï–ù' : '‚ùå –ù–ï–í–ê–õ–ò–î–ï–ù') . "\n";
        
        if ($isValid && $type) {
            echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç–∏–ø: {$type['code']} - {$type['name']}\n";
        }
        
        // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        $normalized = preg_replace('/[^0-9]/', '', $number);
        $digits = str_split(substr($normalized, 0, 10)); // –ü–µ—Ä–≤—ã–µ 10 —Ü–∏—Ñ—Ä
        $digitCount = array_count_values($digits);
        
        $missing = [];
        $twice = [];
        $once = [];
        
        for ($i = 0; $i <= 9; $i++) {
            $count = $digitCount[$i] ?? 0;
            if ($count === 0) {
                $missing[] = $i;
            } elseif ($count === 2) {
                $twice[] = $i;
            } elseif ($count === 1) {
                $once[] = $i;
            }
        }
        
        echo "–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:\n";
        echo "  - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ü–∏—Ñ—Ä—ã: " . implode(', ', $missing) . " (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: " . count($missing) . ")\n";
        echo "  - –¶–∏—Ñ—Ä—ã –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è –¥–≤–∞–∂–¥—ã: " . implode(', ', $twice) . " (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: " . count($twice) . ")\n";
        echo "  - –¶–∏—Ñ—Ä—ã –≤—Å—Ç—Ä–µ—á–∞—é—â–∏–µ—Å—è –æ–¥–∏–Ω —Ä–∞–∑: " . implode(', ', $once) . " (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: " . count($once) . ")\n";
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª IdNr
        $followsIdNrRules = count($missing) === 1 && count($twice) === 1 && count($once) === 8;
        echo "  - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º IdNr: " . ($followsIdNrRules ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢') . "\n";
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª StNr
        $allDigits = str_split($normalized);
        $hasThreeConsecutive = false;
        
        for ($i = 0; $i < 9; $i++) {
            if ($allDigits[$i] === $allDigits[$i + 1] && $allDigits[$i] === $allDigits[$i + 2]) {
                $hasThreeConsecutive = true;
                break;
            }
        }
        
        $allDigitCount = array_count_values($allDigits);
        $hasRepetition = false;
        $maxRepetition = 0;
        
        foreach ($allDigitCount as $count) {
            if ($count >= 2) {
                $hasRepetition = true;
            }
            if ($count > $maxRepetition) {
                $maxRepetition = $count;
            }
        }
        
        $followsStNrRules = !$hasThreeConsecutive && $hasRepetition && $maxRepetition <= 3;
        echo "  - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞–º StNr: " . ($followsStNrRules ? '‚úÖ –î–ê' : '‚ùå –ù–ï–¢') . "\n";
        
        // –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if (!$isValid) {
            if (count($missing) !== 1 || count($twice) !== 1) {
                echo "  - –ü—Ä–∏—á–∏–Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏: –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º IdNr\n";
            } elseif ($hasThreeConsecutive) {
                echo "  - –ü—Ä–∏—á–∏–Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏: —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç—Ä–∏ –ø–æ–¥—Ä—è–¥ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã\n";
            } else {
                echo "  - –ü—Ä–∏—á–∏–Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞\n";
            }
        }
        
    } catch (TINException $e) {
        echo "‚ùå –û–®–ò–ë–ö–ê: " . $e->getMessage() . "\n";
    }
    
    echo "\n" . str_repeat("-", 60) . "\n\n";
}

echo "üìä –í–´–í–û–î–´:\n";
echo "1. –ù–æ–º–µ—Ä–∞ '12 345 678 901' –∏ '48 036 952 129' –Ω–µ–≤–∞–ª–∏–¥–Ω—ã, –ø–æ—Ç–æ–º—É —á—Ç–æ:\n";
echo "   - –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º IdNr (–Ω–µ –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã, –Ω–µ –æ–¥–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)\n";
echo "   - –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º StNr (—Å–æ–¥–µ—Ä–∂–∞—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏)\n\n";

echo "2. –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ\n\n";

echo "3. –ù–∞—à–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ:\n";
echo "   - –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã, —Ç–æ—á–∫–∏)\n";
echo "   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è IdNr –∏ StNr\n";
echo "   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã\n";
echo "   - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø TIN\n\n";

echo "‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!\n"; 